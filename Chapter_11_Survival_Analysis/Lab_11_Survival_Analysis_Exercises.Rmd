---
title: "Lab 11 Survival Analysis Exercises"
author: "Evan Woods"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 6)
knitr::opts_chunk$set(fig.asp = 0.618)
knitr::opts_chunk$set(out.width = "70%")
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(
  comment = ""
)
```

```{r message=FALSE, include=FALSE}
if(!require("MASS")) install.packages("MASS")
if(!require("ISLR2")) install.packages("ISLR2")
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("HH")) install.packages("HH") # VIF
if(!require("e1071")) install.packages("e1071") # naiveBayes
if(!require("class")) install.packages("class") # knn
if(!require("formulaic")) install.packages("formulaic")
if(!require("caTools")) install.packages("caTools")
if(!require("caret")) install.packages("caret")
if(!require("boot")) install.packages("boot")
if(!require("leaps")) install.packages("leaps") # regsubsets
if(!require("glmnet")) install.packages("glmnet") # Ridge and Lasso Regression
if(!require("pls")) install.packages("pls") # Partial Least Squares & Principal Component Regression
if(!require("splines")) install.packages("splines")
if(!require("gam")) install.packages("gam")
if(!require("akima")) install.packages("akima")
if(!require("tree")) install.packages("tree") # Classification and Regression Trees
if(!require("randomForest")) install.packages("randomForest")
if(!require("gbm")) install.packages("gbm") # Boosted Trees
if(!require("BART")) install.packages("BART")
if(!require("reticulate")) install.packages("reticulate") # Use python objects in R
if(!require("ROCR")) install.packages("ROCR")
if(!require("keras")) install.packages("keras") # Install keras for deep learning
if(!require("jpeg")) install.packages("jpeg")
if(!require("imager")) install.packages("imager")
if(!require("survival")) install.packages("survival")

library(survival)
library(imager)
library(keras)
reticulate::use_condaenv(condaenv = "r-tensorflow")
library(ROCR)
library(reticulate)
library(BART)
library(gbm)
library(randomForest)
library(tree)
library(akima)
library(gam)
library(splines)
library(glmnet)
library(pls)
library(leaps)
library(formulaic)
library(class)
library(e1071)
library(HH)
library(MASS)
library(ISLR2)
library(tidyverse)
library(caTools)
library(caret)
library(boot)
library(jpeg)
```

```{r output=FALSE, results = 'hide', message=FALSE}
# keras::install_keras(method = "conda", python_version = "3.10")
```

```{r include=FALSE}
custom_darkblue = "#1A0875"
custom_lightblue = "#34ABEB"
custom_red = "#a60808"
```

```{r include=FALSE}
f_print <- function(string){
  cat(str_wrap(string = string, width = 80, indent = 0, exdent = 0, whitespace_only = TRUE))
}
```

## Applied
### Question 10 (Python):
This exercise focuses on the brain tumor data, which is included in the ISLR2 R library.

* **Question 10-a**: Plot the Kaplan-Meier survival curve with ±1 standard error bands, using the survfit() function in the survival package.
  * **Answer**:
```{r}
# attach(BrainCancer)
# fit.surv <- survfit(Surv(time, status) ~ 1)
# summary(fit.surv)
# plot(fit.surv)
```

```{python}
import matplotlib.pyplot as plt
from matplotlib.pyplot import subplots
import numpy as np
import pandas as pd
from ISLP.models import ModelSpec as MS
from ISLP import load_data

from lifelines import \
    (KaplanMeierFitter, CoxPHFitter)
from lifelines.statistics import \
    (logrank_test, 
     multivariate_logrank_test)
from ISLP.survival import sim_time
```

```{python}
BrainCancer = load_data('BrainCancer')
```

```{python}
# Selecting alpha as 0.01 to create confidence intervals of 99% for which the standard error of the Kaplan-Meier Survival Curve are closest to 1

fig, ax = subplots(figsize = (8,8))
km = KaplanMeierFitter(alpha=(1-.99))
km_brain = km.fit(BrainCancer['time'], BrainCancer['status'])
km_brain.plot(label='Kaplan Meier Estimate', ax = ax)
plt.show()
```

* **Question 10-b**: Draw a bootstrap sample of size n = 88 from the pairs (y, δ), and compute the resulting Kaplan-Meier survival curve. Repeat this process B = 200 times. Use the results to obtain an estimate of the standard error of the Kaplan-Meier survival curve at each timepoint. Compare this to the standard errors obtained in (a). 
  * **Answer (R)**: 
```{r}
attach(BrainCancer)
boot <- sample(c(time, status), size = 88)
fit.surv_a <- survfit(Surv(boot) ~ 1)
```

```{r}
fit.surv_a$std.err
```

```{r}
plot(fit.surv_a)
```


```{r}
boot <- list()
fit.surv <- list()
```

```{r}
boot[[1]] <- sample(c(time, status), size = 88)
fit.surv[[1]] <- survfit(Surv(boot[[1]]) ~ 1)
fit.surv[[1]]$std.err
plot(fit.surv[[1]])
```

```{r}
for (i in seq(1, 200)) {
  boot[[i]] <- sample(c(time, status), size = 88, replace = TRUE)
  fit.surv[[i]] <- survfit(Surv(boot[[i]]) ~ 1)
}
```


* **Question 10-c**: Fit a Cox proportional hazards model that uses all of the predictors to predict survival. Summarize the main findings. 
  * **Answer**:
```{r}
cox.fit <- coxph(Surv(time, status) ~ ., data = BrainCancer)
summary(cox.fit)
f_print(sprintf("The risk of death associated with HG glioma is more than 8 times the risk of death associated with meningioma. This is a statistically significant difference. Because the Karnofsky index is negative, there a lower risk of death and greater chance of life expectancy with an increased Karnofsky score."))
```

* **Question 10-d**: Stratify the data by the value of ki. 
  * **Answer**:
```{r}
fit.Ki <- survfit(Surv(time, status) ~ ki, data = BrainCancer)
fit.Ki
plot(fit.Ki)
```

### Question 11:
This example makes use of the data in Table 11.4.

* **Question 11-a**: Create two groups of observations. In Group 1, X < 2, whereas in Group 2, X >= 2. Plot the Kaplan-Meier survival curves corresponding to the two groups. Be sure to label the curves so that it is clear which curve corresponds to which group. By eye, does there appear to be a difference between the two groups' survival curves?
  * **Answer**:
```{r}
group_1 <- seq(0,1.99, by = 0.01)
group_2 <- seq(2, 3.99, by = 0.01)
```



